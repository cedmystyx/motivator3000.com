<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Motivator 3D Viewer</title>
    <meta name="viewport" content="width=800, initial-scale=1.0">
    <!-- A-Frame core -->
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <!-- Optionally, add environment component for background -->
    <script src="https://cdn.jsdelivr.net/npm/aframe-environment-component@1.3.1/dist/aframe-environment-component.min.js"></script>
    <style>
        body { background: #222; margin: 0; }
        #sceneContainer { width: 800px; height: 450px; margin: 40px auto; }
    </style>
    <!-- Composants pour mains et bras glowing/pulsant -->
    <script>
      AFRAME.registerComponent('attractive-appendage', {
        schema: {
          color: {type: 'color', default: '#00FFF0'},
          arm: {type: 'boolean', default: false},
          armLength: {type: 'number', default: 0.45}
        },
        init: function () {
          this.el.setAttribute('geometry', {
            primitive: 'sphere',
            radius: 0.11
          });
          this.el.setAttribute('material', {
            color: this.data.color,
            emissive: this.data.color,
            emissiveIntensity: 0.8,
            roughness: 0.3,
            metalness: 0.7,
            shader: 'standard',
            transparent: true,
            opacity: 0.97
          });
          this.pulse = 0;
          if (this.data.arm) {
            this.armEntity = document.createElement('a-cylinder');
            this.armEntity.setAttribute('radius', 0.09);
            this.armEntity.setAttribute('height', this.data.armLength);
            this.armEntity.setAttribute('color', this.data.color);
            this.armEntity.setAttribute('material', {
              emissive: this.data.color,
              emissiveIntensity: 0.8,
              roughness: 0.3,
              metalness: 0.7,
              shader: 'standard',
              transparent: true,
              opacity: 0.95
            });
            this.armEntity.setAttribute('position', `0 ${-this.data.armLength/2} 0`);
            this.el.appendChild(this.armEntity);
          }
        },
        tick: function (time, delta) {
          this.pulse += delta * 0.002;
          var scale = 1 + 0.2 * Math.sin(this.pulse * 2);
          this.el.object3D.scale.set(scale, scale, scale);

          var mat = this.el.getObject3D('mesh')?.material;
          if (mat) {
            mat.emissiveIntensity = 0.7 + 0.35 * Math.abs(Math.sin(this.pulse));
            mat.opacity = 0.8 + 0.17 * Math.abs(Math.cos(this.pulse * 1.3));
          }
          if (this.armEntity) {
            var armMat = this.armEntity.getObject3D('mesh')?.material;
            if (armMat) {
              armMat.emissiveIntensity = 0.7 + 0.35 * Math.abs(Math.sin(this.pulse));
              armMat.opacity = 0.8 + 0.17 * Math.abs(Math.cos(this.pulse * 1.3));
            }
          }
        }
      });

      // Bras dynamique qui part de l'épaule vers la main VR/WebXR
      AFRAME.registerComponent('attach-arm-to-shoulder', {
        schema: {
          side: {type: 'string', default: 'left'} // 'left' ou 'right'
        },
        init: function () {
          this.shoulderOffset = (this.data.side === 'left')
            ? new THREE.Vector3(-0.22, 1.36, 0.06)
            : new THREE.Vector3( 0.22, 1.36, 0.06);
          this.armEntity = this.el.querySelector('a-cylinder');
        },
        tick: function () {
          var handObj = this.el.object3D;
          if (!handObj || !this.armEntity) return;
          var handWorld = new THREE.Vector3();
          handObj.getWorldPosition(handWorld);

          var camera = document.querySelector('[camera]');
          if (!camera) return;
          var camObj = camera.object3D;
          var camWorld = new THREE.Vector3();
          camObj.getWorldPosition(camWorld);
          var shoulderWorld = camWorld.clone().add(this.shoulderOffset);

          var dir = new THREE.Vector3().subVectors(handWorld, shoulderWorld);
          var dist = dir.length();
          var mid = new THREE.Vector3().addVectors(shoulderWorld, handWorld).multiplyScalar(0.5);

          this.armEntity.object3D.position.copy(this.armEntity.parent.worldToLocal(mid.clone()));
          var arm = this.armEntity.object3D;
          arm.lookAt(this.armEntity.parent.worldToLocal(handWorld.clone()));
          arm.rotateX(Math.PI/2);
          this.armEntity.setAttribute('height', dist);
        }
      });
    </script>
</head>
<body>
    <div id="sceneContainer">
        <a-scene 
          embedded 
          environment="preset: forest; shadow: true; width: 800px; height: 450px;"
        >
            <a-assets>
                <a-asset-item id="motivator-gltf" src="motivator3000/motivator.gltf"></a-asset-item>
                <img id="motivator-texture" src="motivator3000/texture.png" crossorigin="anonymous">
            </a-assets>
            <!-- GLTF à jour, grand et bien placé -->
            <a-entity 
                gltf-model="#motivator-gltf"
                scale="5 5 5"
                position="0 1.66025 1.5678"
                rotation="89.99963750135457 0 0"
                shadow="cast: true; receive: true"
                animation="property: position; dir: alternate; dur: 2200; easing: easeInOutSine; from: 0 1.5 -2; to: 0 2 -2; loop: true"
            ></a-entity>
            <a-light 
                type="point"
                position="1 3 2"
                intensity="1"
                color="#ffffff"
                castShadow="true">
            </a-light>
            <a-entity camera 
                orbit-controls="target: 0 1 0; minDistance: 1; maxDistance: 10; initialPosition: 0 2 5;">
            </a-entity>
            <!-- Mains VR attractives avec bras -->
            <a-entity
              laser-controls="hand: left"
              attractive-appendage="color: #00fff0; arm: true"
              attach-arm-to-shoulder="side: left"
              shadow="cast: true"
            ></a-entity>
            <a-entity
              laser-controls="hand: right"
              attractive-appendage="color: #ff3cfb; arm: true"
              attach-arm-to-shoulder="side: right"
              shadow="cast: true"
            ></a-entity>
        </a-scene>
    </div>
</body>
</html>
