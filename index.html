<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Scène A-Frame Mains VR Custom avec Bras Style Humain + GLTF</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/aframe-environment-component@1.3.1/dist/aframe-environment-component.min.js"></script>
  <style>
    html, body { height: 100%; width: 100%; margin: 0; overflow: hidden; background: #181818; }
    a-scene { width: 100vw; height: 100vh; min-height: 360px; min-width: 320px; }
  </style>
  <!-- Composant pour main attractive + bras humain -->
  <script>
    // Composant pour main attractive (effet glowing/pulsant)
    AFRAME.registerComponent('attractive-hand', {
      schema: {
        color: {type: 'color', default: '#00FFF0'}
      },
      init: function () {
        this.el.setAttribute('geometry', {
          primitive: 'sphere',
          radius: 0.11
        });
        this.el.setAttribute('material', {
          color: this.data.color,
          emissive: this.data.color,
          emissiveIntensity: 0.8,
          roughness: 0.3,
          metalness: 0.7,
          shader: 'standard',
          transparent: true,
          opacity: 0.97
        });
        this.pulse = 0;
      },
      tick: function (time, delta) {
        this.pulse += delta * 0.002;
        var scale = 1 + 0.2 * Math.sin(this.pulse * 2);
        this.el.object3D.scale.set(scale, scale, scale);
        var mat = this.el.getObject3D('mesh')?.material;
        if (mat) {
          mat.emissiveIntensity = 0.7 + 0.35 * Math.abs(Math.sin(this.pulse));
          mat.opacity = 0.8 + 0.17 * Math.abs(Math.cos(this.pulse * 1.3));
        }
      }
    });

    // Composant pour bras humain qui suit la main
    AFRAME.registerComponent('human-arm', {
      schema: {
        side: {type: 'string', default: 'left'}, // 'left' ou 'right'
        color: {type: 'color', default: '#ffb74d'},
        upperLength: {type: 'number', default: 0.45},
        lowerLength: {type: 'number', default: 0.45}
      },
      init: function () {
        // Création des entités pour le bras
        const sideSign = this.data.side === 'left' ? -1 : 1;
        // Epaule (point d'attache virtuel)
        this.shoulder = new THREE.Object3D();
        this.shoulder.position.set(sideSign * 0.25, 1.4, 0.1);

        // Bras supérieur
        this.upperArm = document.createElement('a-cylinder');
        this.upperArm.setAttribute('radius', 0.09);
        this.upperArm.setAttribute('height', this.data.upperLength);
        this.upperArm.setAttribute('color', this.data.color);
        this.upperArm.setAttribute('position', `${sideSign * 0.19} 1.15 0.14`);
        this.upperArm.setAttribute('rotation', `0 0 ${sideSign * 24}`);
        this.el.sceneEl.appendChild(this.upperArm);

        // Avant-bras
        this.lowerArm = document.createElement('a-cylinder');
        this.lowerArm.setAttribute('radius', 0.08);
        this.lowerArm.setAttribute('height', this.data.lowerLength);
        this.lowerArm.setAttribute('color', '#ffa726');
        this.lowerArm.setAttribute('position', `${sideSign * 0.37} 0.82 0.18`);
        this.lowerArm.setAttribute('rotation', `0 0 ${sideSign * 25}`);
        this.el.sceneEl.appendChild(this.lowerArm);

        // Pour l'animation (on retient le mesh)
        this.upperArmObj = null;
        this.lowerArmObj = null;
      },
      tick: function () {
        // On suit la main VR si possible
        const handObj = this.el.object3D;
        if (!handObj) return;

        // Récupère les meshes
        if (!this.upperArmObj || !this.lowerArmObj) {
          this.upperArmObj = this.upperArm.object3D;
          this.lowerArmObj = this.lowerArm.object3D;
        }
        // Position de l'épaule (fixe pour simplifier)
        const sideSign = this.data.side === 'left' ? -1 : 1;
        const shoulderPos = new THREE.Vector3(sideSign * 0.25, 1.4, 0.1);

        // Position du poignet (main)
        const handWorldPos = new THREE.Vector3();
        handObj.getWorldPosition(handWorldPos);

        // Calcul de la direction épaule-main
        const shoulderToHand = new THREE.Vector3().subVectors(handWorldPos, shoulderPos);
        const length = shoulderToHand.length();

        // Calcul du coude (approximation simple type IK 2-bones)
        const upperLength = this.data.upperLength;
        const lowerLength = this.data.lowerLength;
        let elbowPos = new THREE.Vector3().copy(shoulderPos);
        if (length < upperLength + lowerLength - 0.01) {
          // Triangle law
          const a = upperLength, b = lowerLength, c = length;
          const angleA = Math.acos(Math.min(Math.max((b*b + c*c - a*a)/(2*b*c), -1), 1));
          elbowPos.add(shoulderToHand.clone().setLength(upperLength * Math.cos(angleA)));
          elbowPos.y -= upperLength * Math.sin(angleA) * 0.3;
        } else {
          // Bras tendu
          elbowPos.add(shoulderToHand.clone().setLength(upperLength));
        }

        // Place upper arm
        if (this.upperArmObj) {
          // milieu du segment épaule-coude
          const midUpper = new THREE.Vector3().lerpVectors(shoulderPos, elbowPos, 0.5);
          this.upperArmObj.position.copy(midUpper);
          // Rotation
          this.upperArmObj.lookAt(elbowPos);
          this.upperArmObj.rotateX(Math.PI/2);
        }
        // Place lower arm
        if (this.lowerArmObj) {
          // milieu du segment coude-main
          const midLower = new THREE.Vector3().lerpVectors(elbowPos, handWorldPos, 0.5);
          this.lowerArmObj.position.copy(midLower);
          // Rotation
          this.lowerArmObj.lookAt(handWorldPos);
          this.lowerArmObj.rotateX(Math.PI/2);
        }
      },
      remove: function () {
        this.upperArm.parentNode.removeChild(this.upperArm);
        this.lowerArm.parentNode.removeChild(this.lowerArm);
      }
    });
  </script>
</head>
<body>
  <a-scene
    environment="preset: forest; shadow: true;"
    shadow="type: pcfsoft"
    renderer="antialias: true"
    vr-mode-ui="enabled: true"
    device-orientation-permission-ui="enabled: true"
    background="color: #181818"
  >
    <a-assets>
      <a-asset-item id="motivator-gltf" src="motivator3000/motivator.gltf"></a-asset-item>
      <img id="motivator-texture" src="motivator3000/texture.png" crossorigin="anonymous">
    </a-assets>

    <!-- Main gauche VR custom attractive + bras humain -->
    <a-entity
      laser-controls="hand: left"
      attractive-hand="color: #00fff0"
      human-arm="side: left; color: #ffb74d"
      shadow="cast: true"
    ></a-entity>
    <!-- Main droite VR custom attractive + bras humain -->
    <a-entity
      laser-controls="hand: right"
      attractive-hand="color: #ff3cfb"
      human-arm="side: right; color: #ffb74d"
      shadow="cast: true"
    ></a-entity>

    <!-- Objet GLTF importé -->
    <a-entity
      gltf-model="#motivator-gltf"
      scale="1.2 1.2 1.2"
      position="0 1.5 -2"
      shadow="cast: true; receive: true"
      animation="property: position; dir: alternate; dur: 2200; easing: easeInOutSine; from: 0 1.5 -2; to: 0 2 -2; loop: true"
    ></a-entity>

    <!-- Lumière principale -->
    <a-light type="directional" intensity="1.2" position="2 6 2" castShadow="true"></a-light>

    <!-- Caméra multiplateforme -->
    <a-entity
      camera
      position="0 1.6 4"
      look-controls="enabled: true; touchEnabled: true; mouseEnabled: true"
      wasd-controls
    ></a-entity>
  </a-scene>
</body>
</html>
